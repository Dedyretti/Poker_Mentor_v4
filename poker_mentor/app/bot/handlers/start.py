from app.bot.bot_core import bot
from app.bot.keyboards import get_main_menu, get_game_keyboard
from app.database.crud.users import get_or_create_user
from app.utils.logger import get_logger

logger = get_logger(__name__)

@bot.message_handler(commands=['start'])
def start_command(message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = message.from_user
    logger.info(f"New user started: {user.id} - {user.username}")
    
    # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    db_user = get_or_create_user(
        telegram_id=user.id,
        username=user.username,
        first_name=user.first_name,
        last_name=user.last_name
    )
    
    welcome_text = f"""
üéØ <b>Poker Mentor Pro</b> üéØ

–ü—Ä–∏–≤–µ—Ç, <b>{user.first_name}</b>! üëã

–Ø - —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-—Ç—Ä–µ–Ω–µ—Ä –ø–æ –ø–æ–∫–µ—Ä—É! 
–ü—Ä–æ–∫–∞—á–∏–≤–∞–π –Ω–∞–≤—ã–∫–∏, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä—É–∫–∏ –∏ —Å—Ç–∞–Ω–æ–≤–∏—Å—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–º.

<b>üöÄ –ú–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:</b>

üéÆ <b>–ë—ã—Å—Ç—Ä–∞—è –∏–≥—Ä–∞</b> - –£—á–µ–±–Ω—ã–µ –ø–∞—Ä—Ç–∏–∏ —Å AI
üìä <b>–ê–Ω–∞–ª–∏–∑ —Ä—É–∫</b> - –†–∞–∑–±–æ—Ä —Ç–≤–æ–∏—Ö –∏–≥—Ä–æ–≤—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π  
üéì <b>–û–±—É—á–µ–Ω–∏–µ</b> - –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ —Ç–∞–∫—Ç–∏–∫–∏ –æ—Ç –ø—Ä–æ—Ñ–∏
üìà <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b> - –¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –º–µ—Ç—Ä–∏–∫–∏
üë§ <b>–ü—Ä–æ—Ñ–∏–ª—å</b> - –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —Ä–µ–π—Ç–∏–Ω–≥
üí™ <b>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</b> - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è

<b>–í—ã–±–µ—Ä–∏ —Ä–∞–∑–¥–µ–ª –∏ –Ω–∞—á–Ω–µ–º –ø–æ–∫–µ—Ä–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ! üÉè</b>
    """
    
    bot.send_message(message.chat.id, welcome_text, reply_markup=get_main_menu(), parse_mode='HTML')

@bot.message_handler(commands=['help'])
def help_command(message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = """
üìñ <b>–ü–æ–º–æ—â—å –ø–æ –∫–æ–º–∞–Ω–¥–∞–º:</b>

/start - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
/profile - –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã
/learn - –û–±—É—á–µ–Ω–∏–µ –ø–æ–∫–µ—Ä—É

<b>–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é:</b>
üéÆ <b>–ë—ã—Å—Ç—Ä–∞—è –∏–≥—Ä–∞</b> - –ò–≥—Ä–∞ —Å AI
üìä <b>–ê–Ω–∞–ª–∏–∑ —Ä—É–∫</b> - –ê–Ω–∞–ª–∏–∑ –∏–≥—Ä–æ–≤—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
üéì <b>–û–±—É—á–µ–Ω–∏–µ</b> - –û–±—É—á–∞—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
üìà <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b> - –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
üë§ <b>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</b> - –ü—Ä–æ—Ñ–∏–ª—å –∏–≥—Ä–æ–∫–∞
üí™ <b>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</b> - –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
    """
    bot.send_message(message.chat.id, help_text, parse_mode='HTML')

@bot.message_handler(func=lambda message: message.text == "üéÆ –ë—ã—Å—Ç—Ä–∞—è –∏–≥—Ä–∞")
def start_quick_game(message):
    """–ù–∞—á–∞–ª–æ –±—ã—Å—Ç—Ä–æ–π –∏–≥—Ä—ã"""
    from app.game.game_service import game_service
    
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±—ã—Å—Ç—Ä—É—é –∏–≥—Ä—É —á–µ—Ä–µ–∑ game_service
        engine = game_service.start_quick_game(
            telegram_id=str(message.from_user.id),
            user_data={
                'first_name': message.from_user.first_name,
                'username': message.from_user.username
            }
        )
        
        game_state = engine.get_game_state()
        
        game_text = f"""
üéÆ <b>–ë—ã—Å—Ç—Ä–∞—è –∏–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞!</b>

üÉè <b>–í–∞—à–∏ –∫–∞—Ä—Ç—ã:</b> {' '.join(game_state['players'][0]['hole_cards'])}
üí∞ <b>–ë–ª–∞–π–Ω–¥—ã:</b> {engine.table.blinds['small']}/{engine.table.blinds['big']}
üíµ <b>–í–∞—à —Å—Ç–µ–∫:</b> {game_state['players'][0]['stack']}
üéØ <b>–ü–æ–∑–∏—Ü–∏—è:</b> {game_state['current_player']}
üìä <b>–°—Ç–∞–¥–∏—è:</b> {game_state['state']}

<i>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–π! üéØ</i>
        """
        
        bot.send_message(
            message.chat.id,
            game_text,
            reply_markup=get_game_keyboard(),
            parse_mode='HTML'
        )
        
    except Exception as e:
        logger.error(f"Error starting quick game: {e}")
        bot.send_message(
            message.chat.id,
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–≥—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=get_main_menu()
        )

@bot.message_handler(func=lambda message: message.text == "üìä –ê–Ω–∞–ª–∏–∑ —Ä—É–∫")
def start_analysis(message):
    """–ù–∞—á–∞–ª–æ –∞–Ω–∞–ª–∏–∑–∞ —Ä—É–∫–∏"""
    analysis_text = """
üìä <b>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä—É–∫</b>

üîç <b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>
–ü—Ä–∏—Å—ã–ª–∞–π –æ–ø–∏—Å–∞–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏, –∏ —è:

‚úÖ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —à–∞–Ω—Å—ã –Ω–∞ –ø–æ–±–µ–¥—É
‚úÖ –û—Ü–µ–Ω—é —Å–∏–ª—É —Ç–≤–æ–µ–π —Ä—É–∫–∏ 
‚úÖ –î–∞–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ö–æ–¥–∞–º
‚úÖ –ü–æ–∫–∞–∂—É –≤–æ–∑–º–æ–∂–Ω—ã–µ –∏—Å—Ö–æ–¥—ã

üìù <b>–§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:</b>
<code>‚Ä¢ –ú–æ–∏ –∫–∞—Ä—Ç—ã: A‚ô• K‚ô•
‚Ä¢ –°—Ç–æ–ª: Q‚ô• J‚ô• T‚ô• 2‚ô£ 5‚ô¶
‚Ä¢ –ü–æ–∑–∏—Ü–∏—è: Button
‚Ä¢ –î–µ–π—Å—Ç–≤–∏—è: –ö–æ–ª–ª, –†–µ–π–∑</code>

<i>–ü—Ä–∏—Å—ã–ª–∞–π —Å–≤–æ—é —Ä—É–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞! üéØ</i>
    """
    bot.send_message(
        message.chat.id,
        analysis_text,
        reply_markup=get_main_menu(),
        parse_mode='HTML'
    )

@bot.message_handler(func=lambda message: message.text == "üéì –û–±—É—á–µ–Ω–∏–µ")
def start_learning(message):
    """–ù–∞—á–∞–ª–æ –æ–±—É—á–µ–Ω–∏—è"""
    learning_text = """
üéì <b>–ê–∫–∞–¥–µ–º–∏—è –ø–æ–∫–µ—Ä–∞</b>

üìö <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫—É—Ä—Å—ã:</b>

üÉè <b>–û—Å–Ω–æ–≤—ã –∏–≥—Ä—ã</b>
‚Ä¢ –ü—Ä–∞–≤–∏–ª–∞ –∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
‚Ä¢ –ü–æ–∑–∏—Ü–∏–∏ –∑–∞ —Å—Ç–æ–ª–æ–º

üéØ <b>–ü—Ä–µ—Ñ–ª–æ–ø —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</b>
‚Ä¢ –°—Ç–∞—Ä—Ç–æ–≤—ã–µ —Ä—É–∫–∏
‚Ä¢ –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω–∞—è –∏–≥—Ä–∞
‚Ä¢ –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ —Å—Ç–∏–ª—è–º

üìä <b>–ü–æ—Å—Ç—Ñ–ª–æ–ø –∏–≥—Ä–∞</b>
‚Ä¢ –ß—Ç–µ–Ω–∏–µ –æ–ø–ø–æ–Ω–µ–Ω—Ç–æ–≤
‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–Ω–∫—Ä–æ–ª–ª–æ–º
‚Ä¢ –ë–ª–µ—Ñ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å

üí° <b>–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è</b>
‚Ä¢ –¢–∏–ª—å—Ç-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç
‚Ä¢ –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π
‚Ä¢ –ú–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞

<i>–í—ã–±–µ—Ä–∏ —Ç–µ–º—É –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è! üìñ</i>
    """
    bot.send_message(
        message.chat.id,
        learning_text,
        reply_markup=get_main_menu(),
        parse_mode='HTML'
    )

@bot.message_handler(func=lambda message: message.text == "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
def show_statistics(message):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
    stats_text = """
üìà <b>–¢–≤–æ–π –ø–æ–∫–µ—Ä–Ω—ã–π –ø–∞—Å–ø–æ—Ä—Ç</b>

üèÜ <b>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>
‚Ä¢ üéÆ –°—ã–≥—Ä–∞–Ω–æ –∏–≥—Ä: <b>0</b>
‚Ä¢ ‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö —Ä—É–∫: <b>0%</b>
‚Ä¢ üí∞ –°—Ä–µ–¥–Ω–∏–π –≤—ã–∏–≥—Ä—ã—à: <b>0</b>
‚Ä¢ ‚≠ê –†–µ–π—Ç–∏–Ω–≥: <b>–ù–æ–≤–∏—á–æ–∫</b>

üìä <b>–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:</b>
‚Ä¢ üÉè –ü—Ä–µ—Ñ–ª–æ–ø: —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è...
‚Ä¢ üìç –§–ª–æ–ø: —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è...
‚Ä¢ üîÑ –¢—ë—Ä–Ω: —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è...
‚Ä¢ üèÅ –†–∏–≤–µ—Ä: —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è...

üéØ <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</b>
<i>–°—ã–≥—Ä–∞–π 5+ –∏–≥—Ä –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏!</i>
    """
    bot.send_message(
        message.chat.id,
        stats_text,
        reply_markup=get_main_menu(),
        parse_mode='HTML'
    )

@bot.message_handler(func=lambda message: message.text == "üí™ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏")
def start_training(message):
    """–ù–∞—á–∞–ª–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫"""
    training_text = """
üí™ <b>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π —Ä–µ–∂–∏–º</b>

üéØ <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:</b>

üß† <b>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä—É–∫</b>
‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–ª—ã –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
‚Ä¢ –°–∫–æ—Ä–æ—Å—Ç–Ω–æ–π –∞–Ω–∞–ª–∏–∑

üìä <b>–†–∞—Å—á–µ—Ç —à–∞–Ω—Å–æ–≤</b> 
‚Ä¢ –ê—É—Ç—Å—ã –∏ –ø–æ—Ç –æ–¥–¥—Å—ã
‚Ä¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø–æ–∫–µ—Ä–∞

üéÆ <b>–°–∏–º—É–ª—è—Ç–æ—Ä—ã</b>
‚Ä¢ –°–ª–æ–∂–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏
‚Ä¢ –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π –ø–æ–¥ –¥–∞–≤–ª–µ–Ω–∏–µ–º

üìà <b>–ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫</b>
‚Ä¢ –†–∞–∑–±–æ—Ä —Ç–≤–æ–∏—Ö –ø—Ä–æ—à–ª—ã—Ö –∏–≥—Ä
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

<i>–í—ã–±–µ—Ä–∏ —Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞! üî•</i>
    """
    bot.send_message(
        message.chat.id,
        training_text,
        reply_markup=get_main_menu(),
        parse_mode='HTML'
    )